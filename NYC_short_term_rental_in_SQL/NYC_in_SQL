-- 1) What is the most common room type in NYC Airbnb listings?

SELECT  room_type, count(*)
FROM room_types
GROUP BY 1
ORDER BY count(*) DESC
LIMIT 1;

-- 2) What is the average price of the listings by room type "shared room"?

SELECT  round(AVG(price),2) AS average_price
FROM prices
WHERE listing_id IN (
   SELECT listing_id
   FROM room_types
   WHERE room_type = 'shared room'
);

-- 3) Which borough has the highest average price per month?

SELECT  borough, avg(price_per_month) as avg_per_month
FROM prices
GROUP BY 1
ORDER BY avg_per_month DESC
LIMIT 1;

-- 4) How many listings of each room type are in each borough?

SELECT p.borough, r.room_type, COUNT(*)
FROM room_types as r
INNER JOIN prices as p
ON r.listing_id = p.listing_id
GROUP BY p.borough, r.room_type;

-- 5) How many listings in each room type category have a price greater than $500 per night?

SELECT  room_type, count(*) as numb_listings
FROM room_types
WHERE listing_id IN (
  SELECT listing_id
  FROM prices
  WHERE price > 500
)
GROUP BY 1;

-- 6) What is the distribution (MIN, MAX, AVG) of listing prices by borough?

SELECT borough, min(price), max(price), avg(price)
FROM prices
GROUP BY 1;

-- 7) What is the estimated amount of revenue generated by hosts in each borough?

SELECT p.borough, SUM(p.price * r.booked_days_365) AS estimated_revenue
FROM prices AS p
INNER JOIN reviews AS r ON p.listing_id = r.listing_id
GROUP BY p.borough;

-- 8) What is the average price per month for listings in each neighborhood? 

SELECT p.neighbourhood,
r.room_type,
avg(p.price_per_month) as avg_month
FROM room_types AS r
INNER JOIN  prices AS p
ON p.listing_id = r.listing_id
GROUP BY 1,2
ORDER BY 3 DESC;

-- 9) How many listings have no reviews? 

SELECT *
FROM reviews
WHERE number_of_reviews = 0

-- 10) How do the estimated book days correlate with the price of an Airbnb listing in New York City?

SELECT ROUND(CAST(CORR(p.price, r.booked_days_365)as numeric),4) AS correlation
FROM reviews AS r
INNER JOIN prices AS p ON r.listing_id = p.listing_id;

-- 11) What is the average price per room type for listings that have at least 100 reviews and are available more than 200 days a year?

SELECT ro.room_type, round(avg(p.price), 2)
FROM reviews as re
INNER JOIN room_types as ro
    USING (listing_id)
INNER JOIN prices as p
USING (listing_id)
WHERE number_of_reviews >= 100 and availability_365 > 200
GROUP BY 1

-- 12) How many hosts have more than one listing, and what's the maximum number of listings by a single host name?
-- Number of hosts with more than one listinG
SELECT count(*)
FROM reviews
WHERE calculated_host_listings_count > 1

-- Maximum number of listings by a single host
SELECT host_name, max(calculated_host_listings_count) AS num_listings
FROM reviews
GROUP BY host_name
ORDER BY num_listings DESC
LIMIT 1;

-- 13) Determine the top 5 hosts who have the highest price_per_month for their listings, considering only hosts who have at least 10 listings.

SELECT r.host_name, round(avg(p.price_per_month)) AS total_price
FROM reviews AS r
INNER JOIN prices AS p
  USING (listing_id)
WHERE calculated_host_listings_count >= 10
GROUP BY 1
ORDER BY 2 DESC
LIMIT 5;

-- 14) Find the neighborhood(s) that have the highest variance in listing prices.

SELECT neighbourhood, VARIANCE(price) AS price_variance
FROM prices
GROUP BY neighbourhood
HAVING VARIANCE(price) IS NOT NULL
ORDER BY price_variance DESC
LIMIT 1;

-- 15) Calculate the average price_per_month for each neighborhood, taking into account only listings where the host has a minimum_nights value that is higher than the average minimum_nights value across all listings

SELECT p.neighbourhood, AVG(p.price_per_month) AS average_price
FROM reviews AS r
INNER JOIN prices AS p
ON r.listing_id = p.listing_id
WHERE r.minimum_nights > (
  SELECT AVG(minimum_nights)
  FROM reviews
)
GROUP BY p.neighbourhood
ORDER BY 2 DESC;


